<!DOCTYPE html>
<html lang="pl" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layouts/base-layout}">
<head>
    <title th:text="'Drużyna ' + ${team.name}"></title>
</head>
<body>

<section layout:fragment="content" th:with="
isAdmin=${#authorization.expression('hasRole(''ADMIN'')')},
isAdminOrOwner=${isAdmin or #authentication.name == team.userOwner.username}
">

    <div class="container">

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb p-3 bg-body-tertiary rounded-3">
                <li class="breadcrumb-item">
                    <a th:href="@{/}" class="link-body-emphasis fw-semibold text-decoration-none">Główna strona</a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/team/list}" class="link-body-emphasis fw-semibold text-decoration-none">Drużyny</a>
                </li>
                <li th:text="${team.name}" class="breadcrumb-item active" aria-current="page"></li>
            </ol>
        </nav>

        <div class="d-flex align-items-center p-3 my-3 text-white bg-dark rounded shadow-sm">
            <div class="lh-1">
                <h1 th:text="${team.name}"></h1>
            </div>
        </div>

        <div th:if="${isAdminOrOwner}">


            <p>Kod dla dołączających użytkowników: <code th:text="${{team.secretCode}}"></code></p>

            <div class="d-flex gap-2">
                <form th:action="@{'/team/' + ${team.id} + '/edit'}" method="get" class="m-0">
                    <input type="submit" value="Edytuj drużynę" class="btn btn-secondary btn-sm"/>
                </form>
                <form th:action="@{'/team/' + ${team.id} + '/delete'}" method="post" class="m-0">
                    <input type="submit" value="Usuń drużynę" class="btn btn-danger btn-sm"/>
                </form>
                <form th:action="@{'/team/' + ${team.id} + '/regenerate-secret-code'}" method="post"
                      class="m-0">
                    <input type="submit" value="Wygeneruj ponownie tajny kod" class="btn btn-warning btn-sm"/>
                </form>
            </div>

        </div>


        <div class="row">

            <div class="col-md-8">
                <div class="my-3 p-3 bg-body rounded shadow-sm">
                    <h5 class="border-bottom pb-2 mb-0">Opis</h5>
                    <p th:text="${{team.description}}"/>
                </div>
            </div>

            <div class="col-md-4">
                <div class="my-3 p-3 bg-body rounded shadow-sm">
                    <h5 class="border-bottom pb-2 mb-0">Linki</h5>

                    <table class="table">
                        <tr th:each="link : ${links}">
                            <td>
                                <a th:href="${link.url}" th:text="${{link.name}}"></a>
                            </td>
                            <td th:if="${isAdminOrOwner}" class="text-end">
                                <form method="post" class="m-0"
                                      th:action="@{'/team/' + ${team.id} + '/link/delete/' + ${link.id}}">
                                    <input type="submit" value="Usuń" class="btn btn-danger btn-sm "/>
                                </form>
                            </td>
                        </tr>
                    </table>

                    <a th:if="${isAdminOrOwner}" th:href="@{'/team/' + ${team.id} + '/link/new'}"
                       class="btn btn-link">Dodaj link</a>
                </div>

            </div>

        </div>

        <div class="my-3 p-3 bg-body rounded shadow-sm">
            <h2>Gracze</h2>

            <div sec:authorize="isAuthenticated()">
                <a th:text="'Dołącz do drużyny'" th:href="@{'/team/' + ${teamId} + '/member/apply'}"
                   class="btn btn-link"></a>
            </div>

            <table class="table">
                <thead>
                <tr>
                    <th>Nazwa</th>
                    <th>Gra</th>
                    <th>Data dołączenia</th>
                    <th th:if="${isAdminOrOwner}">
                        Akcje
                    </th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="userRegistration: ${userRegistrations}">
                    <td>
                        <a th:href="@{'/user/' + ${userRegistration.user.id}}"
                           th:text="${{userRegistration.user.username}}"></a>
                    </td>
                    <td>
                        <a th:href="@{'/game/' + ${userRegistration.game.id}}"
                           th:text="${{userRegistration.game.name}}"></a>
                    </td>
                    <td th:text="${{userRegistration.joinDate}}"></td>
                    <td th:if="${isAdminOrOwner}">
                        <form th:action="@{'/team/'+${team.id}+'/member/remove/'+${userRegistration.id}}"
                              method="post" class="m-0">
                            <input type="submit" value="Usuń" class="btn btn-danger btn-sm"/>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="my-3 p-3 bg-body rounded shadow-sm">
            <h2>Turnieje</h2>

            <table class="table">
                <thead>
                <tr>
                    <th>Nazwa</th>
                    <th>Data rozpoczęcia</th>
                    <th>Data zakończenia</th>
                    <th th:if="${isAdminOrOwner}">
                        Akcje
                    </th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="tournamentRegistration: ${tournamentRegistrations}">
                    <td>
                        <a th:href="@{'/tournament/' + ${tournamentRegistration.tournament.id}}"
                           th:text="${{tournamentRegistration.tournament.name}}"></a>
                    </td>
                    <td th:text="${{tournamentRegistration.tournament.startDate}}"></td>
                    <td>
                    <span th:if="${tournamentRegistration.tournament.endDate != null}"
                          th:text="${{tournamentRegistration.tournament.endDate}}"></span>
                    </td>
                    <td th:if="${isAdminOrOwner}">
                        <form th:action="@{'/team/'+${team.id}+'/tournament/leave/'+${tournamentRegistration.id}}"
                              method="post" class="m-0">
                            <input type="submit" value="Opuść" class="btn btn-danger btn-sm"/>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

    </div>
</section>
</body>
</html>